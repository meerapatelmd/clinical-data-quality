---
title: "Primary Template"
author: "Meera Y. Patel, M.D."
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    highlight: kate  
    toc: yes
    number_sections: true
    toc_depth: 3 
    toc_float: 
      collapsed: false  
      smooth_scroll: false
    code_folding: show #or hide
    df_print: paged
    fig_height: 5 
    fig_width: 7 
    fig_caption: true
    dev: png
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "reports") 
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      cache = TRUE,
                      cache.path = "reports/cache/",
                      child = NULL, #file/s to knit and then include,
                      collapse = FALSE, #collapse all output into a single block,
                      error = TRUE, #display error messages in doc. FALSE stops render when error is thrown
                      fig.align = "center", #left, right, center, or default
                      include = TRUE, #include chunk?
                      message = TRUE, #display code messages?
                      tidy = TRUE, #tidy code 
                      warning = TRUE, #include warnings?
                      results = "markup"
                        # "asis": passthrough results
                        # "hide": do not display results 
                        # "hold": put all results below all code
                      )

library(tidyverse)
```
  
  
<---! Getting Data for Glossary 

```{r setup_omop_sample,include=FALSE}
tables <- pg13::ls_tables(conn_fun = 'pg13::local_connect("polyester")',
                          schema = "omop_cdm")

output <- list()
for (table in tables) {
  conn <- pg13::local_connect("polyester")
  
  if (
    pg13::field_exists(conn = conn,
                       schema = "omop_cdm", 
                       table = table,
                       field = "person_id"))   {
    
    # x <-
    #   pg13::query(conn = conn,
    #               sql_statement = 
    #                 SqlRender::render(
    #                   "SELECT * 
    #                   FROM @schema.@table 
    #                   WHERE person_id IN (@person_ids)",
    #                   schema = "omop_cdm",
    #                   table = table,
    #                   person_ids = 1:10
    #   ))
    # 
    concept_id_fields <- pg13::ls_fields(conn = conn,
                                         schema = "omop_cdm",
                                         table = table) 
    concept_id_fields <- grep(pattern = "concept_id",
                              x = concept_id_fields,
                              value = TRUE)
    
    
    output2 <- list()
    for (j in 1:length(concept_id_fields)) {
      
      prefix <- stringr::str_remove_all(string = concept_id_fields[j],
                                        pattern = "_concept_id$")
      
      output2[[j]] <-
        pg13::query(conn = conn,
                    sql_statement = 
      SqlRender::render(
        "
        SELECT a.*, b.concept_name AS @prefix_concept_name 
        FROM omop_cdm.@table a 
        INNER JOIN omop_cdm.concept b
        ON a.@concept_id_field = b.concept_id 
        WHERE a.person_id IN (@person_ids)
        ",
        table = table,
        concept_id_field = concept_id_fields[j],
        prefix = prefix,
        person_ids = 1:100
      ))
    }
    
    
     output[[1+length(output)]] <-
       output2 %>%
       purrr::reduce(left_join) 
    
    names(output)[length(output)] <- table
    
    pg13::dc(conn = conn)
                                            }
}

```



Themes can be viewed at: https://bootswatch.com/3/.  

Syntax Highlighting Styles can be viewed at https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/.  

Dataframe printing options include `default`, `kable`, `tibble`, or `paged`.  

For paged dataframes, the chunk options include:  

* max.print: the number of rows to print  
* rows.print: the number of rows to display    
* cols.print: the number of columns to print  
* cols.min.print: the minimum number of columns to display  
* pages.print: the number of pages to display under page navigation   
* paged.print: when set to `FALSE` turns off paged display for the chunk    
* rownames.print: when set to `FALSE` turns off row names for the chunk  




  
## Analysis  
  
## Conclusions  
  
